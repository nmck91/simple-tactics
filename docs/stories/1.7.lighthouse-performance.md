# Story 1.7: Optimize Mobile Performance and Lighthouse Score

## Status
Draft

## Story
**As a** volunteer coach,
**I want** the app to load quickly on my phone even on 4G connection,
**so that** I can access tactics instantly on the sideline without frustration.

## Acceptance Criteria

1. Lighthouse CI configured in GitHub Actions workflow to run on every build
2. Mobile Lighthouse score achieves: Performance ≥90, Accessibility ≥90, Best Practices ≥90, SEO ≥80
3. Initial bundle size is <500KB (well under 2MB target, leaving room for animations/themes in future epics)
4. Time to Interactive (TTI) is <3 seconds on simulated 4G throttled connection
5. Images and assets optimized (compressed, appropriate formats)
6. Lazy loading implemented for tactic detail views (only load when navigated to)
7. Lighthouse CI fails PR if scores drop below thresholds

## Tasks / Subtasks

- [ ] Task 1: Install and configure Lighthouse CI (AC: 1)
  - [ ] Install Lighthouse CI: `npm install -D @lhci/cli`
  - [ ] Create `lighthouserc.js` configuration file
  - [ ] Define performance budgets and score thresholds
  - [ ] Configure URLs to test (home page, tactic detail page)
  - [ ] Test Lighthouse CI locally: `npx lhci autorun`

- [ ] Task 2: Add Lighthouse CI to GitHub Actions workflow (AC: 1, 7)
  - [ ] Update `.github/workflows/ci.yml`
  - [ ] Add Lighthouse CI step after build
  - [ ] Upload Lighthouse reports as artifacts
  - [ ] Configure workflow to fail if scores below thresholds
  - [ ] Test CI workflow on pull request

- [ ] Task 3: Measure current bundle size (AC: 3)
  - [ ] Run production build: `npm run build`
  - [ ] Check `/out` directory size
  - [ ] Analyze bundle with Next.js built-in analyzer
  - [ ] Identify largest dependencies
  - [ ] Document current bundle size

- [ ] Task 4: Optimize bundle size if needed (AC: 3)
  - [ ] Verify LazyMotion is used (not full Framer Motion)
  - [ ] Remove unused dependencies
  - [ ] Verify Tailwind CSS PurgeCSS is working
  - [ ] Check for duplicate dependencies
  - [ ] Ensure tactics JSON not bundled (served from /public)
  - [ ] Re-measure bundle size after optimizations

- [ ] Task 5: Implement lazy loading for tactic detail pages (AC: 6)
  - [ ] Use Next.js dynamic imports for heavy components
  - [ ] Lazy load FieldCanvas component: `const FieldCanvas = dynamic(() => import('@/components/FieldCanvas'))`
  - [ ] Lazy load AnimationControls component
  - [ ] Add loading skeleton/spinner for lazy components
  - [ ] Verify components load only when navigating to detail page

- [ ] Task 6: Optimize images and assets (AC: 5)
  - [ ] Audit all images in `/public/icons` and `/public/images`
  - [ ] Compress SVG files using SVGO
  - [ ] Convert images to WebP format where applicable
  - [ ] Ensure icons are appropriately sized (not oversized)
  - [ ] Remove unused assets
  - [ ] Document optimization results

- [ ] Task 7: Add meta tags for SEO (AC: 2, SEO ≥80)
  - [ ] Update `app/layout.tsx` with metadata
  - [ ] Add description, keywords, og:tags
  - [ ] Add viewport meta tag (should already exist)
  - [ ] Add theme-color meta tag
  - [ ] Verify meta tags in browser DevTools

- [ ] Task 8: Optimize Time to Interactive (TTI) (AC: 4)
  - [ ] Minimize JavaScript execution on initial load
  - [ ] Defer non-critical JavaScript
  - [ ] Ensure critical CSS inlined (Next.js handles this)
  - [ ] Measure TTI with Lighthouse on 4G throttling
  - [ ] Identify and fix TTI bottlenecks if >3s

- [ ] Task 9: Run Lighthouse audit and fix issues (AC: 2)
  - [ ] Run Lighthouse in Chrome DevTools (mobile mode)
  - [ ] Review Performance score (target ≥90)
  - [ ] Review Accessibility score (target ≥90)
  - [ ] Review Best Practices score (target ≥90)
  - [ ] Review SEO score (target ≥80)
  - [ ] Fix any flagged issues
  - [ ] Re-run audit until targets met

- [ ] Task 10: Test on simulated 4G connection (AC: 4)
  - [ ] Open Chrome DevTools → Network tab
  - [ ] Enable "Slow 4G" throttling
  - [ ] Measure page load time
  - [ ] Measure Time to Interactive (TTI)
  - [ ] Verify TTI < 3 seconds
  - [ ] Document results

- [ ] Task 11: Optimize accessibility score (AC: 2, Accessibility ≥90)
  - [ ] Run axe DevTools or Lighthouse accessibility audit
  - [ ] Fix color contrast issues
  - [ ] Ensure all images have alt text
  - [ ] Verify ARIA labels on interactive elements
  - [ ] Test keyboard navigation (Tab key)
  - [ ] Test with screen reader (VoiceOver or NVDA)

- [ ] Task 12: Create bundle report script
  - [ ] Create `scripts/bundle-report.js`
  - [ ] Analyze build output and generate report
  - [ ] Add to package.json: `"bundle-report": "npm run build && node scripts/bundle-report.js"`
  - [ ] Document bundle size breakdown

- [ ] Task 13: Document performance optimizations
  - [ ] Update README.md with performance targets
  - [ ] Document Lighthouse scores achieved
  - [ ] Document bundle size and TTI metrics
  - [ ] Add instructions for running Lighthouse locally

## Dev Notes

### Previous Story Context
**From Story 1.1:**
- Next.js 14+ with static export configured
- Tailwind CSS with PurgeCSS enabled
- Production build outputs to `/out` directory

**From Story 1.5:**
- Framer Motion with LazyMotion configured (saves ~50KB vs full library)
- Canvas-based field rendering implemented
- FieldCanvas and AnimationControls components created

**From Story 1.6:**
- Test suite configured and running in CI
- CI pipeline runs lint, test, build on every PR

### Lighthouse CI Configuration
**[Source: ui-architecture/frontend-tech-stack.md#bundle-size-analysis]**

**Install Lighthouse CI:**
```bash
npm install -D @lhci/cli
```

**Configuration (lighthouserc.js):**
```javascript
module.exports = {
  ci: {
    collect: {
      staticDistDir: './out',
      url: [
        'http://localhost/index.html',
        'http://localhost/tactic/high-press.html',
      ],
      numberOfRuns: 3,
    },
    assert: {
      assertions: {
        'categories:performance': ['error', { minScore: 0.9 }],
        'categories:accessibility': ['error', { minScore: 0.9 }],
        'categories:best-practices': ['error', { minScore: 0.9 }],
        'categories:seo': ['error', { minScore: 0.8 }],
      },
    },
    upload: {
      target: 'temporary-public-storage',
    },
  },
};
```

**Score Thresholds:**
- Performance: ≥90 (0.9)
- Accessibility: ≥90 (0.9)
- Best Practices: ≥90 (0.9)
- SEO: ≥80 (0.8)

### CI/CD Integration
**[Source: ui-architecture/project-structure.md#github-section]**

**Update .github/workflows/ci.yml:**
```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build project
        run: npm run build

      - name: Run Lighthouse CI         # NEW STEP
        run: |                           # NEW STEP
          npm install -g @lhci/cli       # NEW STEP
          lhci autorun                   # NEW STEP

      - name: Upload Lighthouse reports  # NEW STEP
        uses: actions/upload-artifact@v3 # NEW STEP
        if: always()                     # NEW STEP
        with:                            # NEW STEP
          name: lighthouse-reports       # NEW STEP
          path: .lighthouseci            # NEW STEP
```

**Lighthouse CI Behavior:**
- Runs after build completes
- Tests home page and tactic detail page
- Runs 3 times and takes median score
- Fails CI if any score below threshold
- Uploads reports as GitHub artifacts

### Bundle Size Optimization
**[Source: ui-architecture/frontend-tech-stack.md#bundle-size-analysis]**

**Target Bundle Sizes:**
- Total initial bundle: <500KB (minified + gzipped)
- Remaining budget: ~1,500KB for future epics

**Bundle Breakdown (estimated):**
- Next.js runtime: ~400KB
- Framer Motion (LazyMotion): 45KB
- Tailwind CSS (purged): ~50KB
- Custom components: ~80KB
- **Total: ~575KB** (may need optimization to reach <500KB)

**Optimization Strategies:**
1. **Verify LazyMotion:** Ensure using `m.div` not `motion.div`
2. **Tailwind PurgeCSS:** Verify unused classes removed
3. **Remove unused deps:** Check for accidentally installed packages
4. **Code splitting:** Lazy load tactic detail page components

**Measure Bundle Size:**
```bash
npm run build
du -sh out/_next/static/chunks/*.js | sort -h
```

**Bundle Analyzer (optional):**
```bash
npm install -D @next/bundle-analyzer
```

### Lazy Loading Strategy
**[Source: ui-architecture/project-structure.md#next-js-patterns]**

**Lazy Load Heavy Components:**
```tsx
import dynamic from 'next/dynamic'

// Lazy load FieldCanvas (contains Canvas API and Framer Motion)
const FieldCanvas = dynamic(() => import('@/components/FieldCanvas'), {
  loading: () => <div className="animate-pulse bg-gray-200 h-96 rounded"></div>,
  ssr: false, // Canvas not available on server
})

// Lazy load AnimationControls
const AnimationControls = dynamic(() => import('@/components/AnimationControls'), {
  ssr: false,
})

export default function TacticDetailPage({ params }) {
  const tactic = await loadTacticById(params.id)

  return (
    <div>
      <h1>{tactic.title}</h1>
      <FieldCanvas tactic={tactic} />
      <AnimationControls />
    </div>
  )
}
```

**Benefits:**
- FieldCanvas and AnimationControls only load when user navigates to detail page
- Reduces initial bundle loaded on home page
- Improves Time to Interactive (TTI)

### Image Optimization
**[Source: ui-architecture/frontend-tech-stack.md#image-optimization]**

**Static Export Mode - Manual Optimization:**
Next.js Image Optimization API disabled (`images: { unoptimized: true }`), so manual optimization required.

**SVG Optimization:**
```bash
# Install SVGO
npm install -g svgo

# Optimize all SVGs
svgo -f public/icons/superhero
svgo -f public/icons/professional
```

**WebP Conversion:**
```bash
# Convert PNG/JPG to WebP
# Use online tool: squoosh.app
# Or install cwebp CLI tool
```

**Asset Checklist:**
- ✅ Compress SVG icons (SVGO)
- ✅ Convert raster images to WebP
- ✅ Remove unused icons/images
- ✅ Ensure icons appropriately sized (e.g., 24x24px, not 512x512px scaled down)

### SEO Meta Tags
**[Source: ui-architecture/frontend-developer-standards.md]**

**Update app/layout.tsx:**
```tsx
export const metadata = {
  title: 'Simple Tactics - Youth Soccer Tactics for Coaches',
  description: 'Interactive soccer tactics visualizer for youth coaches. View and animate tactical concepts for 5v5, 7v7, and 9v9 formats.',
  keywords: 'soccer tactics, youth coaching, 5v5, 7v7, 9v9, soccer drills',
  authors: [{ name: 'Simple Tactics' }],
  viewport: 'width=device-width, initial-scale=1, maximum-scale=5',
  themeColor: '#2d5016',
  openGraph: {
    title: 'Simple Tactics',
    description: 'Interactive soccer tactics for youth coaches',
    type: 'website',
    url: 'https://simple-tactics.vercel.app',
  },
}
```

**Per-Page Metadata (tactic detail pages):**
```tsx
export async function generateMetadata({ params }) {
  const tactic = await loadTacticById(params.id)

  return {
    title: `${tactic.title} - Simple Tactics`,
    description: tactic.description.professional,
  }
}
```

### Time to Interactive (TTI) Optimization
**[Source: ui-architecture/frontend-tech-stack.md#performance]**

**Target:** TTI < 3 seconds on Slow 4G (4G throttling in Chrome DevTools)

**Optimization Strategies:**
1. **Minimize JavaScript:** Lazy load non-critical components
2. **Defer JavaScript:** Use Next.js automatic code splitting
3. **Inline Critical CSS:** Next.js handles automatically
4. **Preload Critical Resources:** Fonts, critical CSS

**Measure TTI:**
1. Chrome DevTools → Lighthouse
2. Select "Mobile" device
3. Enable "Simulated throttling" (4G)
4. Run audit
5. Check "Time to Interactive" metric

**Common TTI Bottlenecks:**
- Large JavaScript bundles (solution: code splitting)
- Blocking third-party scripts (solution: defer or remove)
- Excessive DOM size (solution: reduce component complexity)
- Long tasks (solution: break up JavaScript execution)

### Accessibility Optimization
**[Source: ui-architecture/frontend-developer-standards.md#wcag-compliance]**

**WCAG 2.1 AA Requirements:**
1. **Color Contrast:** Minimum 4.5:1 for text, 3:1 for large text/UI components
2. **Keyboard Navigation:** All interactive elements reachable via Tab key
3. **Focus Indicators:** Visible focus state on all focusable elements
4. **Alt Text:** All images have descriptive alt attributes
5. **ARIA Labels:** Screen-reader-friendly labels on interactive elements
6. **Semantic HTML:** Use proper HTML5 tags (`<header>`, `<main>`, `<nav>`)

**Common Lighthouse Accessibility Issues:**
- ❌ Low color contrast (fix: adjust colors)
- ❌ Missing alt text on images (fix: add alt attributes)
- ❌ Missing ARIA labels on buttons (fix: add aria-label)
- ❌ Missing focus indicators (fix: add focus:ring-2 Tailwind class)

**Test Accessibility:**
```bash
# Browser extensions
- axe DevTools (Chrome/Firefox)
- WAVE (Chrome/Firefox)

# Screen readers
- VoiceOver (macOS: Cmd+F5)
- NVDA (Windows: free screen reader)
```

### Performance Budget
**[Source: ui-architecture/frontend-tech-stack.md#bundle-size-analysis]**

**Lighthouse CI Performance Budget:**
```javascript
// lighthouserc.js
budgets: [
  {
    path: '/*',
    resourceSizes: [
      { resourceType: 'script', budget: 500 }, // 500KB JavaScript
      { resourceType: 'stylesheet', budget: 50 }, // 50KB CSS
      { resourceType: 'image', budget: 100 }, // 100KB images
      { resourceType: 'total', budget: 2000 }, // 2MB total (NFR6)
    ],
  },
],
```

**Fail CI if budget exceeded:**
Lighthouse CI automatically fails if bundle size exceeds budget.

### Lighthouse Scores Interpretation

**Performance (≥90):**
- First Contentful Paint (FCP): <1.8s
- Largest Contentful Paint (LCP): <2.5s
- Time to Interactive (TTI): <3.9s
- Speed Index: <3.4s
- Total Blocking Time (TBT): <200ms
- Cumulative Layout Shift (CLS): <0.1

**Accessibility (≥90):**
- Color contrast meets WCAG AA
- All images have alt text
- Form elements have labels
- ARIA used correctly
- Keyboard navigation works

**Best Practices (≥90):**
- Uses HTTPS (Vercel handles)
- No browser errors in console
- Images appropriately sized
- No deprecated APIs used

**SEO (≥80):**
- Meta description present
- Page has title
- Viewport meta tag present
- Font sizes legible on mobile
- Tap targets appropriately sized

### Testing Lighthouse Locally

**Run Lighthouse in Chrome DevTools:**
1. Open app in Chrome
2. Open DevTools (F12)
3. Click "Lighthouse" tab
4. Select "Mobile" device
5. Select categories: Performance, Accessibility, Best Practices, SEO
6. Click "Analyze page load"
7. Review scores and recommendations

**Run Lighthouse CI Locally:**
```bash
npm run build
npx lhci autorun
```

**View Reports:**
Reports saved to `.lighthouseci/` directory.

### Common Performance Issues and Fixes

**Issue: Large JavaScript Bundle**
- **Cause:** Full Framer Motion library instead of LazyMotion
- **Fix:** Verify using `m.div` from `framer-motion` (LazyMotion)

**Issue: Low Performance Score (<90)**
- **Cause:** TTI > 3 seconds
- **Fix:** Lazy load FieldCanvas and AnimationControls

**Issue: Low Accessibility Score (<90)**
- **Cause:** Color contrast, missing alt text, no ARIA labels
- **Fix:** Audit with axe DevTools, fix flagged issues

**Issue: Images Too Large**
- **Cause:** Uncompressed images
- **Fix:** Compress with SVGO (SVG) or convert to WebP (raster)

**Issue: CLS (Cumulative Layout Shift) > 0.1**
- **Cause:** Elements shifting during load (e.g., images without width/height)
- **Fix:** Reserve space for images, use CSS aspect-ratio

### Package.json Scripts
**Add to package.json:**
```json
{
  "scripts": {
    "lighthouse": "lhci autorun",
    "bundle-report": "npm run build && du -sh out/_next/static/chunks/*.js"
  }
}
```

**Usage:**
```bash
npm run lighthouse       # Run Lighthouse CI locally
npm run bundle-report    # Analyze bundle sizes
```

### Documentation

**Update README.md:**
```markdown
## Performance

This app is optimized for mobile performance on 4G connections.

### Lighthouse Scores
- Performance: ≥90
- Accessibility: ≥90
- Best Practices: ≥90
- SEO: ≥80

### Bundle Size
- Initial bundle: <500KB (gzipped)
- Total budget: 2MB

### Run Lighthouse Locally
```bash
npm run build
npm run lighthouse
```

### Performance Targets
- Time to Interactive (TTI): <3s on Slow 4G
- First Contentful Paint (FCP): <1.8s
- Largest Contentful Paint (LCP): <2.5s
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story creation from Epic 1, Story 1.7 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes List
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results
_To be populated by QA agent after implementation_
